#!/usr/bin/env perl
use v5.36;

$| = 1;

# This program demonstrates the BOX:: log-streaming protocol understood by
# "box run" and "box create".  Run it with:
#
#   box run LABEL perl - < eg/demo-logstream
#
# or copy it to the remote box and run it directly.
#
# The four phases shown:
#
#   1. Pre-task output  — lines before any BOX::START pass straight through
#                         to the terminal.
#
#   2. Successful tasks — BOX::START begins an animated countdown; a second
#                         BOX::START implicitly completes the first.
#
#   3. Task with errors — BOX::ERROR flushes buffered output (indented) and
#                         prints an error line, but the task stays active.
#
#   4. BOX::FINISH      — completes the task without starting a new one;
#                         subsequent lines pass straight through.

# ── Phase 1: pre-task output ─────────────────────────────────────────────────

say "Checking prerequisites...";
sleep 1;
say "Perl version: $]";
sleep 1;
say "All checks passed.";
sleep 1;

# ── Phase 2: successful tasks ─────────────────────────────────────────────────

say "BOX::START::Install dependencies";
say "Building Foo-1.23...";
sleep 2;
say "Building Bar-4.56...";
sleep 2;
say "All modules built.";

# Starting a new task implicitly completes the previous one.
say "BOX::START::Run test suite";
say "t/basic.t .... ok";
sleep 1;
say "t/advanced.t . ok";
sleep 2;
say "All tests passed.";

# ── Phase 3: task with a non-fatal error ──────────────────────────────────────

# Starting this task implicitly completes "Run test suite".
say "BOX::START::Deploy to staging";
say "Uploading build artifacts...";
sleep 2;
say "Warning: artifact checksum mismatch on foo.tar.gz";
say "Retrying upload...";
sleep 1;

# BOX::ERROR flushes the buffer and prints the error, but the task continues.
say "BOX::ERROR::checksum mismatch on foo.tar.gz (retrying)";
sleep 1;
say "Re-upload succeeded.";
say "Contacting staging host...";
sleep 2;
say "Deployment confirmed.";

# ── Phase 4: BOX::FINISH ──────────────────────────────────────────────────────

say "BOX::FINISH";
say "Post-deploy smoke test: OK";
sleep 1;
say "All done.";
